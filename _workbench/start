#!/bin/bash

PROJECT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_NAME="$(basename "$PROJECT_DIR")"
WORKBENCH_DIR="$(cd "$PROJECT_DIR/../.." && pwd)/_workbench"
WATCHER_DIR="$PROJECT_DIR/.metadata/watcher"
AGENTS_DIR="$PROJECT_DIR/agents"
SESSION_NAME="$PROJECT_NAME"

GLOBAL_PROMPT="$WORKBENCH_DIR/PROMPT.md"
PROJECT_PROMPT="$PROJECT_DIR/PROMPT.md"

check_dependencies() {
    if ! command -v zellij &> /dev/null; then
        echo "zellij is not installed. Install: brew install zellij"
        exit 1
    fi
    if ! command -v fswatch &> /dev/null; then
        echo "fswatch is not installed. Install: brew install fswatch"
        exit 1
    fi
}

is_session_running() {
    # Check if session exists and is not EXITED
    zellij list-sessions 2>/dev/null | grep "$SESSION_NAME" | grep -qv "EXITED"
}

cleanup_dead_session() {
    # Delete EXITED session if exists
    if zellij list-sessions 2>/dev/null | grep "$SESSION_NAME" | grep -q "EXITED"; then
        zellij delete-session "$SESSION_NAME" --force 2>/dev/null
    fi
}

zj() {
    zellij --session "$SESSION_NAME" action "$@"
}

cleanup() {
    echo "Cleaning up..."
    pkill -f "fswatch.*$PROJECT_DIR/agents" 2>/dev/null
    rm -f "$WATCHER_DIR/watcher.pid"
}

# Truncate tab name to 32 chars with ... in middle if needed
truncate_tab_name() {
    local name="$1"
    local max_len=32
    local len=${#name}

    if [ $len -le $max_len ]; then
        echo "$name"
    else
        local keep=$(( (max_len - 3) / 2 ))
        local left="${name:0:$keep}"
        local right="${name: -$keep}"
        echo "${left}...${right}"
    fi
}

handle_task() {
    local task_file="$1"
    local agent_dir=$(dirname "$task_file")
    local task_name=$(basename "$agent_dir")

    # Only process files named "task"
    if [[ "$(basename "$task_file")" != "task" ]]; then
        return
    fi

    local tab_marker="$agent_dir/.tab-created"

    # Skip if already processed
    if [ -f "$tab_marker" ]; then
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Task already processed: $task_name" >> "$WATCHER_DIR/watcher.log"
        return
    fi

    echo "[$(date '+%Y-%m-%d %H:%M:%S')] New task detected: $task_name" >> "$WATCHER_DIR/watcher.log"

    # Build system prompt from global and project PROMPT files
    local system_prompt=""
    if [ -f "$GLOBAL_PROMPT" ]; then
        system_prompt=$(cat "$GLOBAL_PROMPT")
    fi
    if [ -f "$PROJECT_PROMPT" ]; then
        if [ -n "$system_prompt" ]; then
            system_prompt="$system_prompt"$'\n\n---\n\n'
        fi
        system_prompt="$system_prompt$(cat "$PROJECT_PROMPT")"
    fi

    # Read task content
    local task_content=""
    if [ -f "$task_file" ]; then
        task_content=$(cat "$task_file")
    fi

    # Build the user prompt with task context
    local user_prompt="# Task: $task_name

**Workspace**: $agent_dir

$task_content"

    # Save prompts to files
    echo "$system_prompt" > "$agent_dir/system-prompt.txt"
    echo "$user_prompt" > "$agent_dir/user-prompt.txt"

    # Create new tab with truncated name and working emoji
    local display_name=$(truncate_tab_name "$task_name")
    local tab_name="ðŸ¤–${display_name}"
    zj new-tab --name "$tab_name" --cwd "$PROJECT_DIR"
    touch "$tab_marker"
    sleep 0.5

    # Name the left pane "agent"
    zj rename-pane "agent"

    # Split vertically (creates right pane for user)
    zj new-pane --direction right --name "user"

    # Helper to send text + Enter to agent pane
    send_to_agent() {
        zj go-to-tab-name "$tab_name" 2>/dev/null
        zj move-focus left
        sleep 0.1
        zj write-chars "$1"
        sleep 0.1
        zj write 13  # Enter key
    }

    # Start claude interactively with system prompt (export TASK_NAME and SESSION_NAME for /done command)
    send_to_agent "export TASK_NAME='$task_name' ZELLIJ_SESSION_NAME='$SESSION_NAME' && claude --dangerously-skip-permissions --system-prompt \"\$(cat $agent_dir/system-prompt.txt)\""

    # Wait for claude to start
    sleep 2

    # Check if confirmation is needed
    local screen_content
    screen_content=$(zellij --session "$SESSION_NAME" action dump-screen 2>/dev/null || echo "")
    if echo "$screen_content" | grep -qiE "trust|Trust this project|y/n|\[y\]|Are you sure"; then
        send_to_agent "y"
        sleep 1
    fi

    # Send the task instruction
    send_to_agent "Read and execute the task from $agent_dir/user-prompt.txt"

    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Created tab: $tab_name, sent task to claude" >> "$WATCHER_DIR/watcher.log"
}

start_watcher() {
    # Wait for session to start
    for i in {1..30}; do
        if is_session_running; then
            break
        fi
        sleep 0.5
    done

    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Watcher started" >> "$WATCHER_DIR/watcher.log"

    # Watch agents directory for new task files
    fswatch -x --event Created --event Renamed -r "$PROJECT_DIR/agents" 2>/dev/null | while read -r line; do
        changed_file=$(echo "$line" | awk '{print $1}')

        # Skip directories
        if [ -d "$changed_file" ]; then
            continue
        fi

        # Only process files named "task"
        if [[ "$(basename "$changed_file")" != "task" ]]; then
            continue
        fi

        if ! is_session_running; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Session not running, stopping watcher" >> "$WATCHER_DIR/watcher.log"
            break
        fi

        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Task file detected: $changed_file" >> "$WATCHER_DIR/watcher.log"

        handle_task "$changed_file"
    done
}

start_session() {
    check_dependencies

    # Create directories
    mkdir -p "$WATCHER_DIR"
    mkdir -p "$AGENTS_DIR"
    touch "$WATCHER_DIR/watcher.log"

    # Clean up tab markers from previous session
    find "$AGENTS_DIR" -name ".tab-created" -delete 2>/dev/null

    echo "Starting session '$SESSION_NAME'..."

    # Start watcher in background
    start_watcher &
    local watcher_pid=$!
    echo "$watcher_pid" > "$WATCHER_DIR/watcher.pid"

    # Cleanup on exit
    trap cleanup EXIT

    # Start zellij session with layout
    cd "$PROJECT_DIR"
    zellij -s "$SESSION_NAME" -n "$WORKBENCH_DIR/layout.kdl"

    # This runs after zellij exits
    cleanup
}

# Check if already inside zellij session
if [ -n "$ZELLIJ" ]; then
    echo "Already inside zellij session. Ignoring."
    exit 0
fi

# Add _workbench/bin to PATH
export PATH="$WORKBENCH_DIR/bin:$PATH"

# Clean up dead session if exists
cleanup_dead_session

# If session exists, attach to it; otherwise start new
if is_session_running; then
    echo "Attaching to existing session '$SESSION_NAME'..."
    zellij attach "$SESSION_NAME"
else
    start_session
fi
