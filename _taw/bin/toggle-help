#!/bin/bash

# Toggle help popup window
# If help is open, close it. If closed, open it.
# Uses tmux user option for reliable state tracking (same pattern as popup-shell)

set -e

SESSION_NAME="${1:-}"
if [ -z "$SESSION_NAME" ]; then
    echo "Usage: toggle-help SESSION_NAME" >&2
    exit 1
fi

# Resolve TAW_HOME if not set
if [ -z "$TAW_HOME" ]; then
    SCRIPT_PATH="$(cd "$(dirname "$0")" && pwd)"
    TAW_HOME="$(cd "$SCRIPT_PATH/../.." && pwd)"
fi

# tmux helper
tm() {
    tmux -L "taw-$SESSION_NAME" "$@"
}

# Check if help popup is currently open (using tmux user option)
HELP_OPEN=$(tm show-options -gqv @taw_help_open 2>/dev/null || echo "")

if [ "$HELP_OPEN" = "1" ]; then
    # Help is currently shown - close it using display-popup -C
    # This is the proper way to close a popup (same as popup-shell)
    tm set-option -g @taw_help_open ""
    tm display-popup -C 2>/dev/null || true
else
    # Help is not shown - open it
    # First ensure state is clean, then set it
    tm set-option -g @taw_help_open ""
    tm set-option -g @taw_help_open "1"

    # Create lesskey configuration inside the popup command
    # This binds Alt+/ (\e/) to quit, allowing toggle with same key
    # Uses LESSKEYIN (for less 5.6+) to pass the source file directly
    # The lesskey file is created, used, and cleaned up all within the popup shell
    # Note: The cleanup command runs when less exits (naturally or via key binding)
    tm display-popup -E -w 80% -h 80% -T " Help (âŒ¥/ or q to close) " \
        -s 'fg=terminal,bg=terminal' \
        "KEYFILE=\$(mktemp) && printf '#command\n\\\\e/ quit\n' > \"\$KEYFILE\" && LESSKEYIN=\"\$KEYFILE\" less '$TAW_HOME/_taw/HELP.md'; tmux -L 'taw-$SESSION_NAME' set-option -g @taw_help_open '' 2>/dev/null || true; rm -f \"\$KEYFILE\" 2>/dev/null || true"
fi
