#!/bin/bash

# TAW End Task
# Ends the current task: kills claude, cleans up worktree/branch, closes window
# Called from ^x keybinding
#
# Usage:
#   end-task <session> <window_id>         - Check merge status, confirm if not merged
#   end-task <session> <window_id> --force - Skip merge check, cleanup immediately

set -e

# Source common utilities
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/_common.sh"

TAW_HOME=$(get_taw_home)

# Arguments
SESSION_NAME="$1"
WINDOW_ID="$2"
FORCE_MODE="$3"

if [ -z "$SESSION_NAME" ] || [ -z "$WINDOW_ID" ]; then
    echo "Usage: end-task <session_name> <window_id> [--force]"
    exit 1
fi

# Get task name from window (remove emoji prefix)
get_task_name() {
    local window_name
    window_name=$(tm "$SESSION_NAME" display-message -t "$WINDOW_ID" -p '#{window_name}' 2>/dev/null) || return 1
    # Remove emoji prefix (ðŸ¤– ðŸ’¬ âœ…)
    echo "$window_name" | sed 's/^[ðŸ¤–ðŸ’¬âœ…]*//'
}

# Find .taw directory by walking up from path
find_taw_dir() {
    local dir="$1"
    while [ "$dir" != "/" ]; do
        if [ -d "$dir/.taw" ]; then
            echo "$dir"
            return 0
        fi
        dir=$(dirname "$dir")
    done
    return 1
}

TASK_NAME=$(get_task_name)
if [ -z "$TASK_NAME" ]; then
    echo "Could not determine task name from window"
    exit 1
fi

# Get pane path and find project directory
PANE_PATH=$(tm "$SESSION_NAME" display-message -t "$WINDOW_ID" -p '#{pane_current_path}' 2>/dev/null)
PROJECT_DIR=$(find_taw_dir "$PANE_PATH")

if [ -z "$PROJECT_DIR" ]; then
    echo "Could not find .taw directory"
    exit 1
fi

TAW_DIR="$PROJECT_DIR/.taw"
AGENT_DIR="$TAW_DIR/agents/$TASK_NAME"
LOG_FILE="$TAW_DIR/.metadata/log/end-task.log"

# Ensure log directory exists
mkdir -p "$(dirname "$LOG_FILE")"

log "=== End task: $TASK_NAME ===" "$LOG_FILE"
debug "PROJECT_DIR=$PROJECT_DIR, AGENT_DIR=$AGENT_DIR"

# Check if agent directory exists
if [ ! -d "$AGENT_DIR" ]; then
    log "Agent directory not found: $AGENT_DIR" "$LOG_FILE"
    # Just close the window
    tm "$SESSION_NAME" kill-window -t "$WINDOW_ID" 2>/dev/null || true
    exit 0
fi

# Check if this is git mode
IS_GIT_MODE=false
if [ -f "$TAW_DIR/.is-git-repo" ]; then
    IS_GIT_MODE=true
fi

# === Merge Status Check (git mode only, skip if --force) ===
if [ "$IS_GIT_MODE" = true ] && [ "$FORCE_MODE" != "--force" ]; then
    MERGED=false

    # Check if PR exists and is merged
    PR_FILE="$AGENT_DIR/.pr"
    if [ -f "$PR_FILE" ]; then
        PR_NUMBER=$(cat "$PR_FILE")
        PR_STATE=$(gh pr view "$PR_NUMBER" --json merged -q '.merged' 2>/dev/null || echo "false")
        if [ "$PR_STATE" = "true" ]; then
            MERGED=true
            log "PR #$PR_NUMBER is merged" "$LOG_FILE"
        fi
    fi

    # If no PR or PR not merged, check if branch is merged to main
    if [ "$MERGED" = false ]; then
        git -C "$PROJECT_DIR" fetch origin main 2>/dev/null || true
        if git -C "$PROJECT_DIR" branch --merged main 2>/dev/null | grep -q "\\b$TASK_NAME\\b"; then
            MERGED=true
            log "Branch $TASK_NAME is merged to main" "$LOG_FILE"
        fi
    fi

    # If not merged, ask for confirmation
    if [ "$MERGED" = false ]; then
        log "Task not merged, requesting confirmation" "$LOG_FILE"
        tm "$SESSION_NAME" confirm-before -p "Task '$TASK_NAME' is NOT merged. Delete anyway? (y/n)" \
            "run-shell '$TAW_HOME/_taw/bin/end-task \"$SESSION_NAME\" \"$WINDOW_ID\" --force'"
        exit 0
    fi
fi

# === Cleanup ===
log "Starting cleanup" "$LOG_FILE"

# 1. Kill claude process (send Ctrl+C)
debug "Stopping claude..."
tm "$SESSION_NAME" send-keys -t "${WINDOW_ID}.0" C-c 2>/dev/null || true
sleep 0.3
tm "$SESSION_NAME" send-keys -t "${WINDOW_ID}.0" C-c 2>/dev/null || true
sleep 0.3

# 2. Clean up task (worktree, branch, agent dir)
cleanup_task "$TASK_NAME" "$PROJECT_DIR" "$AGENT_DIR" "$IS_GIT_MODE"

# 3. Close window
debug "Closing window..."
tm "$SESSION_NAME" kill-window -t "$WINDOW_ID" 2>/dev/null || true

log "Cleanup completed" "$LOG_FILE"

# 4. Process queue (start next queued task if any)
debug "Checking queue for next task..."
"$TAW_HOME/_taw/bin/process-queue" "$SESSION_NAME" &
