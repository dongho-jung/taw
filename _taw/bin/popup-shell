#!/bin/bash

# TAW Popup Shell
# Opens a toggleable popup shell in the current worktree directory
# Alt+P toggles the popup (open/close)
#
# Usage:
#   popup-shell <session_name>

set -e

# Source common utilities
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/_common.sh"

# Arguments
SESSION_NAME="$1"

if [ -z "$SESSION_NAME" ]; then
    echo "Usage: popup-shell <session_name>"
    exit 1
fi

# Check if popup is currently open (using tmux user option)
POPUP_OPEN=$(tmux -L "taw-$SESSION_NAME" show-options -gqv @taw_popup_open 2>/dev/null || echo "")

if [ "$POPUP_OPEN" = "1" ]; then
    # Popup is open, close it
    tmux -L "taw-$SESSION_NAME" set-option -g @taw_popup_open ""
    tmux -L "taw-$SESSION_NAME" display-popup -C
    exit 0
fi

# Get current pane's working directory (this is the worktree path)
PANE_PATH=$(tmux -L "taw-$SESSION_NAME" display-message -p '#{pane_current_path}')

if [ -z "$PANE_PATH" ]; then
    PANE_PATH="$HOME"
fi

# Detect user's shell
USER_SHELL="${SHELL:-/bin/bash}"
SHELL_NAME=$(basename "$USER_SHELL")

# Create temporary rcfile for popup shell
TMP_RCFILE=$(mktemp)

case "$SHELL_NAME" in
    zsh)
        # Use unquoted heredoc to allow variable expansion for SESSION_NAME
        cat > "$TMP_RCFILE" << RCFILE
# Source user's zshrc for full environment
[[ -f ~/.zshrc ]] && source ~/.zshrc

# Function to properly close popup and clear state
_taw_close_popup() {
    tmux -L 'taw-$SESSION_NAME' set-option -g @taw_popup_open '' 2>/dev/null || true
    exit
}

# Bind Alt+P to close popup (toggle close from inside popup)
bindkey -s '\ep' '\C-u_taw_close_popup\n'
RCFILE
        ;;
    *)
        # Default to bash behavior
        # Use unquoted heredoc to allow variable expansion for SESSION_NAME
        cat > "$TMP_RCFILE" << RCFILE
# Load user's bashrc if exists
[ -f ~/.bashrc ] && source ~/.bashrc

# Function to properly close popup and clear state
_taw_close_popup() {
    tmux -L 'taw-$SESSION_NAME' set-option -g @taw_popup_open '' 2>/dev/null || true
    exit
}

# Bind Alt+P to close popup (toggle close from inside popup)
bind '"\ep": "\C-u_taw_close_popup\n"'
RCFILE
        ;;
esac

# Mark popup as open (clear first to ensure clean state)
tmux -L "taw-$SESSION_NAME" set-option -g @taw_popup_open ""
tmux -L "taw-$SESSION_NAME" set-option -g @taw_popup_open "1"

# Build shell command based on shell type
case "$SHELL_NAME" in
    zsh)
        # Zsh doesn't support --rcfile, so we create a temp ZDOTDIR
        TMP_ZDOTDIR=$(mktemp -d)
        mv "$TMP_RCFILE" "$TMP_ZDOTDIR/.zshrc"
        SHELL_CMD="ZDOTDIR='$TMP_ZDOTDIR' zsh; rm -rf '$TMP_ZDOTDIR'"
        ;;
    *)
        # Bash supports --rcfile directly
        SHELL_CMD="bash --rcfile '$TMP_RCFILE'; rm -f '$TMP_RCFILE'"
        ;;
esac

# Show popup with interactive shell
# - 80% width, 60% height
# - Uses user's default shell config (no custom prompt)
# - -E flag makes popup close when shell exits
# - -s flag sets style to use default colors (adapts to light/dark themes)
# When popup exits (naturally or via Alt+P), clean up the state
tmux -L "taw-$SESSION_NAME" display-popup \
    -E \
    -w 80% -h 60% \
    -d "$PANE_PATH" \
    -T " Shell " \
    -s 'fg=terminal,bg=terminal' \
    "$SHELL_CMD; tmux -L 'taw-$SESSION_NAME' set-option -g @taw_popup_open '' 2>/dev/null || true"
