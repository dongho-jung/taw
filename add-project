#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECTS_DIR="$SCRIPT_DIR/projects"
WORKBENCH_DIR="$SCRIPT_DIR/_workbench"

mkdir -p "$WORKBENCH_DIR"

# Loop until valid git root is selected
while true; do
    # Open project with yazi
    temp_file=$(mktemp)
    yazi --chooser-file="$temp_file" ~

    if [ ! -s "$temp_file" ]; then
        rm -f "$temp_file"
        echo "No directory selected."
        exit 1
    fi

    selected_path=$(cat "$temp_file")
    rm -f "$temp_file"

    if [ ! -d "$selected_path" ]; then
        echo "Selected path is not a directory."
        exit 1
    fi

    # Check if it's a git repository root
    git_root=$(git -C "$selected_path" rev-parse --show-toplevel 2>/dev/null)

    if [ -z "$git_root" ]; then
        echo ""
        echo "⚠️  Warning: '$selected_path' is not a git repository."
        echo "Please select a git project root directory."
        echo ""
        read -p "Press Enter to select again..."
        continue
    fi

    # Normalize paths for comparison
    selected_real=$(cd "$selected_path" && pwd -P)
    git_root_real=$(cd "$git_root" && pwd -P)

    if [ "$selected_real" != "$git_root_real" ]; then
        echo ""
        echo "⚠️  Warning: '$selected_path' is not the git root."
        echo "Git root is: $git_root"
        echo "Please select the git project root directory."
        echo ""
        read -p "Press Enter to select again..."
        continue
    fi

    # Valid git root selected
    break
done

dir_name=$(basename "$selected_path")
project_dir="$PROJECTS_DIR/$dir_name"

mkdir -p "$project_dir"
mkdir -p "$project_dir/agents"
mkdir -p "$project_dir/.metadata"
mkdir -p "$project_dir/.metadata/watcher"
mkdir -p "$project_dir/.metadata/log"
touch "$project_dir/.metadata/watcher/watcher.log"

# Create symlink
rm -f "$project_dir/location" 2>/dev/null
ln -s "$selected_path" "$project_dir/location"

# Create project PROMPT.md if not exists
if [ ! -f "$project_dir/PROMPT.md" ]; then
    echo "# Project Prompt" > "$project_dir/PROMPT.md"
    echo "" >> "$project_dir/PROMPT.md"
    echo "Add project-specific instructions here." >> "$project_dir/PROMPT.md"
fi

# Create symlink to start script
rm -f "$project_dir/start" 2>/dev/null
ln -s "$WORKBENCH_DIR/start" "$project_dir/start"

# Create symlink to .claude directory (for shared slash commands)
rm -rf "$project_dir/.claude" 2>/dev/null
ln -s "$WORKBENCH_DIR/claude" "$project_dir/.claude"

# Make project root read-only
chmod a-w "$project_dir"

echo ""
echo "Project created: $dir_name"
echo "Location: $selected_path"
echo ""

cd "$project_dir" && exec ./start
